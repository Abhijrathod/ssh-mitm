CVE-2021-36370
==============

.. raw:: html

    <div class="card card-margin">
        <div class="card-header no-border">
            <h5 class="card-title cve-title">CVE-2021-36370</h5>
        </div>
        <div class="card-body pt-0">
            <div class="widget-49">
                <div class="widget-49-title-wrapper">
                    <div class="widget-49-date-primary">
                        <span class="widget-49-date-day">7.4</span>
                        <span class="widget-49-date-month">CVSS</span>
                    </div>
                    <div class="widget-49-meeting-info">
                        <span class="widget-49-pro-title"><b>Vector:</b> CVSS:3.1/AV:N/AC:H/PR:N/UI:N/S:U/C:H/I:H/A:N</span>
                        <span class="widget-49-meeting-time">
                            <a href="https://nvd.nist.gov/vuln/detail/CVE-2021-36370">https://nvd.nist.gov/vuln/detail/CVE-2021-36370</a>
                        </span>
                    </div>
                </div>
                <p class="widget-49-meeting-integration">
                    <i class="far fa-times-circle"></i> not integrated in SSH-MITM server
                </p>
                <p class="widget-49-meeting-text">
                An issue was discovered in Midnight Commander through 4.8.26. When establishing an SFTP connection, the fingerprint of the server is neither checked nor displayed. As a result, a user connects to the server without the ability to verify its authenticity.
                </p>
                <span class="widget-49-pro-title"><b>Affected Software:</b></span>
                <ul class="widget-49-meeting-points">
                    <li class="widget-49-meeting-item"><b>Midnight Commander</b> 4.8.4 - 4.8.26 </li>
                </ul>
            </div>
        </div>
    </div>

Midnight Commander from version 4.8.4 up to 4.8.26 does not verify the host fingerprint when connecting to a server using the SFTP VFS.

The SFTP VFS was introduces in 2012 as an addition to the shell connection, which uses `FISH <https://en.wikipedia.org/wiki/Files_transferred_over_shell_protocol>`_.

The problem was, that the host fingerprint was caclucated, but not verified.
Instead it continued with the authentication step, which makes SFTP connections vulnerable to man in the middle attacks.

.. code-block:: c
    :emphasize-lines: 6,7,9

    /* At this point we havn't yet authenticated.  The first thing to do
     * is check the hostkey's fingerprint against our known hosts Your app
     * may have it hard coded, may go to a file, may present it to the
     * user, that's your call
     */
    sftpfs_super->fingerprint =
    libssh2_hostkey_hash (sftpfs_super->session, LIBSSH2_HOSTKEY_HASH_SHA1);

    if (!sftpfs_recognize_auth_types (super))
    {
        int sftp_errno;

        sftp_errno = libssh2_session_last_errno (sftpfs_super->session);
        sftpfs_ssherror_to_gliberror (sftpfs_super, sftp_errno, mcerror);
        return (-1);
    }


Release Announcement
--------------------

.. note::

    Hi there,

    I'm glad to announce the immediate availability of mc-4.8.27, a maintenance and security release, just in time before leaving all of you for a long overdue summer vacation!

    This release addresses an important security issue (CVE-2021-36370) in the SFTP VFS. Unfortunately, as the VFS was first introduced, the fingerprints of remote hosts were computed, but not verified, and the issue reported only now by Manfred KAISER from AUT-milCERT during an audit of open source software. We would like to thank the team at AUT-milCERT for finding the issue and responsibly disclosing it!

    ...

    - -- Sincerely yours,

    Yury V. Zaytsev


**Source:** https://mail.gnome.org/archives/mc-devel/2021-August/msg00008.html


Mitigation
----------

Update Midnight Commander to version >= 4.8.27

If updating to the latest version is not possible, the shell connection (FISH) can be used for remote file operations over ssh.


References
----------

* https://midnight-commander.org/wiki/NEWS-4.8.27
* https://mail.gnome.org/archives/mc-devel/2021-August/msg00008.html
* https://github.com/MidnightCommander/mc/blob/a88a626e76139259e5b6fc0db39045f051e243dd/src/vfs/sftpfs/connection.c#L479
* https://www.bundesheer.at/cms/artikel.php?ID=11021
